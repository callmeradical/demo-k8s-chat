# ArgoCD Application manifest for k8s-chat
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k8s-chat-demo
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: 'oci://docker.io/callmeradical/k8s-chat'
    targetRevision: '2.0.0'
    helm:
      values: |
        # Use external secrets for API key (recommended)
        secrets:
          anthropic:
            create: true
            external: true
            secretStore: "vault-backend"
            externalKey: "anthropic/api-keys"
            externalProperty: "api-key"
            refreshInterval: "1h"

          # Reference the manually created secret
          additional:
            - envName: "DATABASE_URL"
              secretName: "k8s-chat-demo-database"
              secretKey: "database-url"
              optional: false

            - envName: "DB_USERNAME"
              secretName: "k8s-chat-demo-database"
              secretKey: "username"
              optional: false

            - envName: "DB_PASSWORD"
              secretName: "k8s-chat-demo-database"
              secretKey: "password"
              optional: false

        # Or use sealed secrets approach
        # secrets:
        #   anthropic:
        #     create: false  # Create SealedSecret separately

        # Demo configuration
        replicaCount: 1
        image:
          tag: "main"

        service:
          type: NodePort
          nodePort: 30302
  destination:
    server: 'https://kubernetes.default.svc'
    namespace: demo
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
    managedNamespaceMetadata:
      labels:
        app.kubernetes.io/managed-by: argocd
