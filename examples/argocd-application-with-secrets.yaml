# ArgoCD Application Update - Adding Secrets to k8s-chat
# This shows how to update a running ArgoCD application to consume new secrets

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k8s-chat-demo
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: 'oci://docker.io/callmeradical/k8s-chat'
    targetRevision: '2.0.0'
    helm:
      values: |
        # Existing Anthropic API key configuration
        secrets:
          anthropic:
            create: true
            apiKey: "your-anthropic-key"

          # NEW: Reference manually created secrets
          additional:
            - envName: "DATABASE_URL"
              secretName: "k8s-chat-demo-database"
              secretKey: "database-url"
              optional: false

            - envName: "DB_USERNAME"
              secretName: "k8s-chat-demo-database"
              secretKey: "username"
              optional: false

            - envName: "DB_PASSWORD"
              secretName: "k8s-chat-demo-database"
              secretKey: "password"
              optional: false

            - envName: "REDIS_URL"
              secretName: "k8s-chat-demo-database"
              secretKey: "redis-url"
              optional: true  # Redis is optional

        # Demo configuration (unchanged)
        replicaCount: 1
        image:
          tag: "main"

        service:
          type: NodePort
          nodePort: 30302

  destination:
    server: 'https://kubernetes.default.svc'
    namespace: demo

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
    managedNamespaceMetadata:
      labels:
        app.kubernetes.io/managed-by: argocd

---
# Optional: ArgoCD sync annotation to force immediate sync
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-sync-trigger
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-options: Delete=false
data:
  trigger: "secret-update-$(date +%s)"
