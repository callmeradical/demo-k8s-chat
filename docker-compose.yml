version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: k8s-chat-backend
    ports:
      - "8000:8000"
    environment:
      # Anthropic configuration
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_MODEL=claude-3-5-sonnet-20241022
      - ANTHROPIC_MAX_TOKENS=4096
      
      # Goose configuration
      - GOOSE_PROVIDER=anthropic
      - GOOSE_MODEL=claude-3-5-sonnet-20241022
      - GOOSE_MAX_TOKENS=4096
      
      # MCP Server configuration
      - K8S_MCP_SERVER_URL=http://k8s-mcp-server:8080
      
      # Logging
      - LOG_LEVEL=INFO
      - DEBUG=false
      
      # Development settings
      - CORS_ORIGINS=http://localhost:3000,http://frontend:80
    volumes:
      - ~/.kube:/root/.kube:ro  # Mount kubeconfig for local k8s access
    networks:
      - k8s-chat-network
    depends_on:
      - k8s-mcp-server
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: k8s-chat-frontend
    ports:
      - "3000:80"
    environment:
      - REACT_APP_API_URL=http://localhost:8000
    networks:
      - k8s-chat-network
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MCP Server for Kubernetes operations
  # This is a placeholder - replace with actual MCP server implementation
  k8s-mcp-server:
    image: ${DOCKERHUB_USERNAME:-your-dockerhub-username}/k8s-mcp-server:latest
    container_name: k8s-chat-mcp-server
    ports:
      - "8080:8080"
    volumes:
      - ~/.kube:/root/.kube:ro  # Mount kubeconfig for k8s access
    environment:
      - KUBECONFIG=/root/.kube/config
      - LOG_LEVEL=INFO
    networks:
      - k8s-chat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  k8s-chat-network:
    driver: bridge

volumes:
  kubeconfig:
    driver: local
