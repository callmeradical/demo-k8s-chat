name: ğŸ¦¢ Real Goose K8s Chat CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: docker.io  # Using Docker Hub
  IMAGE_NAME: demo-k8s-chat-goose-web

jobs:
  validate:
    name: ğŸ” Validate & Test
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: âš™ï¸ Install Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.14.0'

    - name: ğŸ” Run validation tests
      run: make ci-test

    - name: ğŸ”’ Run security scan
      run: make ci-security-scan
      continue-on-error: true  # Don't fail CI on security warnings

  test-k8s:
    name: â˜¸ï¸ Test Kubernetes Integration
    runs-on: ubuntu-latest

    strategy:
      matrix:
        k8s-version: ['1.28.0', '1.29.0', '1.30.0']

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Start minikube
      uses: medyagh/setup-minikube@master
      with:
        kubernetes-version: ${{ matrix.k8s-version }}
        driver: docker

    - name: âš™ï¸ Install Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.14.0'

    - name: ğŸ”¨ Build Docker image
      run: |
        make build
        minikube image load demo-k8s-chat-goose-web:latest

    - name: ğŸ¬ Setup demo environment
      run: make demo-setup

    - name: ğŸ§ª Test Helm deployment (dry-run)
      run: |
        helm template k8s-chat ./helm/k8s-chat \
          --set secrets.anthropic.apiKey="test-key" \
          --set image.pullPolicy=Never \
          --dry-run

    - name: ğŸ“‹ Verify cluster state
      run: |
        kubectl get nodes
        kubectl get pods -n demo
        kubectl get services -n demo

  build-and-publish:
    name: ğŸ—ï¸ Build & Publish
    runs-on: ubuntu-latest
    needs: [validate, test-k8s]
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'

    permissions:
      contents: read
      packages: write

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”‘ Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha

    - name: ğŸ”¨ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.goose
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: ğŸ“¦ Package Helm chart
      run: |
        helm package ./helm/k8s-chat

    - name: ğŸ“¤ Upload Helm chart
      uses: actions/upload-artifact@v4
      with:
        name: helm-chart
        path: k8s-chat-*.tgz
        retention-days: 30

  deploy-demo:
    name: ğŸ¬ Deploy Demo Environment
    runs-on: ubuntu-latest
    needs: [validate, test-k8s]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Start minikube
      uses: medyagh/setup-minikube@master
      with:
        kubernetes-version: '1.30.0'
        driver: docker

    - name: âš™ï¸ Install Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.14.0'

    - name: ğŸ”¨ Build and load image
      run: |
        make build
        minikube image load demo-k8s-chat-goose-web:latest

    - name: ğŸ¬ Deploy demo environment
      run: |
        make demo-setup

    - name: ğŸ“Š Show deployment status
      run: |
        echo "::group::Cluster Status"
        kubectl cluster-info
        echo "::endgroup::"

        echo "::group::Demo Workloads"
        kubectl get all -n demo
        echo "::endgroup::"

        echo "::group::Available Commands for Goose Demo"
        echo "- Show me all pods in the demo namespace"
        echo "- Scale the demo-nginx deployment to 5 replicas"
        echo "- Show me the service endpoints"
        echo "- What deployments are running?"
        echo "- Show me cluster information"
        echo "::endgroup::"

  codespaces-setup:
    name: ğŸš€ Verify Codespaces Setup
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âœ… Validate devcontainer config
      run: |
        if [ -f ".devcontainer/devcontainer.json" ]; then
          echo "âœ… devcontainer.json exists"
          # Basic JSON validation
          python -m json.tool .devcontainer/devcontainer.json > /dev/null
          echo "âœ… devcontainer.json is valid JSON"
        else
          echo "âš ï¸ No devcontainer.json found"
        fi

    - name: ğŸ” Check setup script
      run: |
        if [ -f ".devcontainer/setup.sh" ]; then
          echo "âœ… Codespaces setup script exists"
          chmod +x .devcontainer/setup.sh
          # Basic syntax check
          bash -n .devcontainer/setup.sh
          echo "âœ… Setup script syntax is valid"
        else
          echo "âš ï¸ No setup script found"
        fi
